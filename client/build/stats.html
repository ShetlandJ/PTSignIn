<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Young Person</title>
  <script src="bundle.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.bundle.js"></script>
  <link rel="stylesheet" href="style.css">

</head>
<body>

  <div class="topnav">
    <button onClick="today()">Today</button>
    <button onClick=thisMonth()>This Month</button>
    <button onClick="thisYear()">This Year</button>
    <button>All time</button>
  </div>

  <div id="visits">
    <h2 id="visits-today"></h2>
  </div>

  <div class="chartBlock">
    <canvas id="month-visits-chart"></canvas>
  </div>
  <script>

  var getDaysInMonth = function(month, year) {

    var date = new Date(year, month, 1);
    var days = [];
    console.log('month', month, 'date.getMonth()', date.getMonth())
    while (date.getMonth() === month) {
      days.push(new Date(date));
      date.setDate(date.getDate() + 1);
    }
    return days;
  }

  var renderBarChart = function(myData) {

    var today = new Date();
    var mm = today.getMonth()+1

    var dayMonth = []
    var visits = []
    var days_array = getDaysInMonth(mm, 2018)

    for (var day of days_array) {
      dayMonth.push(day.getDate())
    }

    var today = new Date();
    var mm = today.getMonth()+1
    var yy = today.getYear()
    for (var i = 0; i < dayMonth.length; i++) {
      visitDayCount = 0
      for (var visit of myData) {
        visitDate = new Date(visit.date)

        if (visitDate.getDate() === dayMonth[i] && visitDate.getMonth()+1 === mm) {
          visitDayCount += 1;
        }
      }
      visits.push(visitDayCount);
    }

    var ctx = document.getElementById("month-visits-chart").getContext('2d');
    var myBarChart = new Chart(ctx, {
      type: 'horizontalBar',
      data: {
        labels: dayMonth,
        backgroundColor: '#FFFFFF',
        backgroundColor: '#FFFFFF',
        datasets: [{
          label: 'Visits this month by day',
          data: visits,
          backgroundColor:
          '#CC0033',
          borderColor: [
          ],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero:true
            }
          }]
        }
      }
    });
  }

  var home = function() {

    const url = 'https://api.mlab.com/api/1/databases/signins/collections/signins?apiKey=Vp2I1nmC961_lV2whDojmmOuZzXb0S_o';

    var makeRequest = function(url, callback){
      var request = new XMLHttpRequest();
      request.open("GET", url);
      request.addEventListener("load", callback);
      request.send();
    }

    var requestComplete = function(){
      if (this.status !== 200) return;
      var jsonString = this.responseText;
      myData = JSON.parse(jsonString);
      today()
      renderBarChart(myData);
    }

    makeRequest(url, requestComplete)
  }

  var today = function() {

    var renderToday = function(myData) {
      var today = new Date();
      var dd = today.getDate()
      var mm = today.getMonth()+1
      var yy = today.getYear()

      let counter = 0
      for (var visit of myData) {
        visitDate = new Date(visit.date)

        if (visitDate.getDate() === dd && visitDate.getMonth()+1 === mm && visitDate.getYear() === yy) {
          counter += 1
        }

        document.getElementById('visits-today').innerText = "Visits today: " + counter
      }
    }

    renderToday(myData)
  }


  var thisMonth = function() {

    var renderMonth = function(myData) {
      var today = new Date();
      var dd = today.getDate()
      var mm = today.getMonth()+1
      var yy = today.getYear()

      let counter = 0
      for (var visit of myData) {
        visitDate = new Date(visit.date)

        if (visitDate.getMonth()+1 === mm && visitDate.getYear() === yy) {
          counter += 1
        }

        document.getElementById('visits-today').innerText = "Visits this month: " + counter
      }
    }

    renderMonth(myData);
  }

  var thisYear = function() {

    var renderYear = function(myData) {
      var today = new Date();
      var dd = today.getDate()
      var mm = today.getMonth()+1
      var yy = today.getYear()

      let counter = 0
      for (var visit of myData) {
        visitDate = new Date(visit.date)

        if (visitDate.getYear() === yy) {
          counter += 1
        }

        document.getElementById('visits-today').innerText = "Visits this year: " + counter
      }
    }

    renderYear(myData);
  }




  window.addEventListener( 'load', home);
  </script>

</body>
</html>
